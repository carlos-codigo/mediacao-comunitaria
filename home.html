<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Media√ß√£o Comunit√°ria ‚Äî Home</title>

  <!-- ‚úÖ Fonte principal -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- ‚úÖ CSS GLOBAL (DESKTOP) -->
  <link rel="stylesheet" href="css/global-dasktop.css" media="(min-width: 801px)">

  <!-- ‚úÖ CSS GLOBAL (MOBILE) -->
  <link rel="stylesheet" href="css/global-mobile.css" media="(max-width: 800px)">

  <!-- ‚úÖ CSS HOME (DESKTOP) -->
  <link rel="stylesheet" href="css/home-dasktop.css" media="(min-width: 801px)">

  <!-- ‚úÖ CSS HOME (MOBILE) -->
  <link rel="stylesheet" href="css/home-mobile.css" media="(max-width: 800px)">
</head>

<body>

  <!-- ‚úÖ PART√çCULAS DE FUNDO (mantidas em desktop e mobile) -->
  <div class="particles" id="particles"></div>

  <div class="layout">

    <!-- ‚úÖ SIDEBAR (desktop fixa / mobile oculta com overlay) -->
    <aside id="sidebar">
      <div class="brand">
        <img src="assets/imagens/logo2.png" alt="Logo" />
        <div>
          <h1>Media√ß√£o Comunit√°ria</h1>
          <small>√Årea do Usu√°rio</small>
        </div>
      </div>

      <!-- ‚úÖ Navega√ß√£o -->
      <nav>
        <a class="nav-link active" href="home.html"><span class="ico">üè†</span> In√≠cio</a>
        <a class="nav-link" href="conflito.html"><span class="ico">üìù</span> Registrar Conflito</a>
        <a class="nav-link" href="andamento.html"><span class="ico">üìÇ</span> Meus Conflitos</a>
        <a class="nav-link" href="dados.html"><span class="ico">üë§</span> Meus Dados</a>
        <a class="nav-link" href="chat.html"><span class="ico">üì®</span> Suporte / Chat</a>
        <a class="nav-link" href="#" id="sairBtn"><span class="ico">üö™</span> Sair</a>
      </nav>

      <!-- ‚úÖ Rodap√© da sidebar -->
      <div class="sidebar-footer">
        <div id="whoami">Conectando‚Ä¶</div>
      </div>
    </aside>

    <!-- ‚úÖ √ÅREA PRINCIPAL -->
    <main>

      <!-- ‚úÖ √ÅREA SUPERIOR (Header) -->
      <header class="top">
        <div class="hello">

          <!-- ‚úÖ BOT√ÉO DO MENU (s√≥ aparece no mobile via CSS) -->
          <button class="toggle" id="toggleMenu">‚ò∞ Menu</button>

          <h2>Bem-vindo üëã</h2>
          <small id="welcomeLine">Carregando seus dados‚Ä¶</small>
        </div>

        <!-- ‚úÖ A√ß√µes r√°pidas -->
        <div class="quick-actions">
          <button class="btn" onclick="location.href='conflito.html'">+ Novo Conflito</button>
          <button class="btn" onclick="location.href='andamento.html'">Ver Andamento</button>
        </div>
      </header>

      <!-- ‚úÖ CONTE√öDO PRINCIPAL -->
      <section class="content">

        <!-- ‚úÖ KPIs / Indicadores -->
        <div class="card kpi">
          <h3>Conflitos abertos (voc√™)</h3>
          <div class="val" id="kpiTotal">‚Äî</div>
          <div class="hint">Todos os seus registros</div>
        </div>

        <div class="card kpi">
          <h3>Em an√°lise</h3>
          <div class="val" id="kpiAnalise">‚Äî</div>
          <div class="hint">Aguardando avalia√ß√£o inicial</div>
        </div>

        <div class="card kpi">
          <h3>Em andamento</h3>
          <div class="val" id="kpiAndamento">‚Äî</div>
          <div class="hint">Media√ß√£o em curso</div>
        </div>

        <div class="card kpi">
          <h3>Resolvidos</h3>
          <div class="val" id="kpiResolvidos">‚Äî</div>
          <div class="hint">Casos finalizados</div>
        </div>

        <!-- ‚úÖ √öltimos conflitos -->
        <div class="card wide">
          <h3 style="margin-bottom:8px;">Seus √∫ltimos conflitos</h3>
          <div class="list" id="ultimos">
            <div class="item"><span>Carregando‚Ä¶</span></div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- ‚úÖ SDK DO SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ SCRIPT PRINCIPAL (Auth + KPIs + Dados do usu√°rio) -->
  <script>
    // ========= SUPABASE =========
    const SUPABASE_URL = "https://dtriltzrvdhnlxqbiced.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0cmlsdHpydmRobmx4cWJpY2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDM1NzMsImV4cCI6MjA3Njk3OTU3M30.S4gwVrXBiM3wbmp_LOfaFhpbTlnnaw7fZNSgpbzDI28";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ========= ELEMENTOS DA INTERFACE =========
    const sidebar = document.getElementById('sidebar');
    const toggleMenu = document.getElementById('toggleMenu');
    const sairBtn = document.getElementById('sairBtn');
    const whoami = document.getElementById('whoami');
    const welcomeLine = document.getElementById('welcomeLine');

    const kpiTotal = document.getElementById('kpiTotal');
    const kpiAnalise = document.getElementById('kpiAnalise');
    const kpiAndamento = document.getElementById('kpiAndamento');
    const kpiResolvidos = document.getElementById('kpiResolvidos');
    const ultimos = document.getElementById('ultimos');

    // ========= PART√çCULAS DE FUNDO =========
    (function spawnParticles(){
      const wrap = document.getElementById('particles');
      const W = window.innerWidth;
      const H = window.innerHeight;
      const N = Math.min(120, Math.floor((W*H)/18000));
      for(let i=0;i<N;i++){
        const d = document.createElement('div');
        d.className = 'dot';
        d.style.left = Math.random()*100 + 'vw';
        d.style.top = (Math.random()*100) + 'vh';
        d.style.animationDelay = (Math.random()*12)+'s';
        d.style.opacity = (0.35 + Math.random()*0.65).toFixed(2);
        d.style.transform = `translateY(${Math.random()*110}vh)`;
        wrap.appendChild(d);
      }
    })();

    // ========= INICIALIZA√á√ÉO =========
    init().catch(console.error);

    async function init(){
      const { data: { user } } = await db.auth.getUser();
      if(!user){ window.location.href = 'index.html'; return; }

      const nome = user.user_metadata?.nome || user.email || 'Usu√°rio';
      whoami.textContent = `Logado como: ${nome}`;
      welcomeLine.textContent = `Ol√°, ${nome}! Aqui est√° um resumo das suas media√ß√µes.`;

      await Promise.all([
        loadKpis(user.id),
        loadUltimos(user.id),
      ]);
    }

    async function countFor(userId, status){
      let q = db.from('conflitos')
                .select('id', { count: 'exact', head: true })
                .eq('usuario_id', userId);
      if(status) q = q.eq('status', status);
      const { count, error } = await q;
      return error ? 0 : (count || 0);
    }

    async function loadKpis(userId){
      const [total, analise, andamento, resolvidos] = await Promise.all([
        countFor(userId, null),
        countFor(userId, 'Em an√°lise'),
        countFor(userId, 'Em andamento'),
        countFor(userId, 'Resolvido'),
      ]);
      kpiTotal.textContent = total;
      kpiAnalise.textContent = analise;
      kpiAndamento.textContent = andamento;
      kpiResolvidos.textContent = resolvidos;
    }

    async function loadUltimos(userId){
      let orderCol = 'criado_em';
      let { data, error } = await db.from('conflitos')
        .select('*')
        .eq('usuario_id', userId)
        .order(orderCol, { ascending:false })
        .limit(5);

      if(error){
        orderCol = 'created_at';
        ({ data, error } = await db.from('conflitos')
          .select('*')
          .eq('usuario_id', userId)
          .order(orderCol, { ascending:false })
          .limit(5));
      }

      ultimos.innerHTML = '';
      if(error || !data || !data.length){
        ultimos.innerHTML = `<div class="item"><span>Nenhum conflito encontrado.</span></div>`;
        return;
      }

      data.forEach(c=>{
        const status = (c.status || 'Em an√°lise');
        const tagClass =
          status === 'Resolvido' ? 'ok' :
          (status.includes('andamento') || status.includes('Andamento')) ? 'prog' : 'wait';
        const quando = (c[orderCol] ? new Date(c[orderCol]) : null);
        const dt = quando ? quando.toLocaleString('pt-BR') : '‚Äî';

        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div>
            <div style="font-weight:600">${escapeHTML(c.titulo || 'Conflito sem t√≠tulo')}</div>
            <small style="color:var(--muted)">Atualizado: ${dt}</small>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="tag ${tagClass}">${escapeHTML(status)}</span>
            <button class="btn" style="padding:8px 10px; border-radius:10px;"
              onclick="location.href='andamento.html?id=${encodeURIComponent(c.id)}'">Abrir</button>
          </div>
        `;
        ultimos.appendChild(div);
      });
    }

    // ========= Logout =========
    sairBtn?.addEventListener('click', async (e)=>{
      e.preventDefault();
      await db.auth.signOut();
      localStorage.removeItem('usuario');
      window.location.href = 'index.html';
    });

    // ========= Seguran√ßa (evita XSS) =========
    function escapeHTML(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }
  </script>

  <!-- ‚úÖ SCRIPT DO MENU MOBILE + OVERLAY (N√ÉO REMOVER) -->
  <script>
    const sidebarMobile = document.getElementById("sidebar");
    const toggleMobile = document.getElementById("toggleMenu");

    // cria overlay se n√£o existir
    let overlay = document.getElementById("menu-overlay");
    if (!overlay) {
      overlay = document.createElement("div");
      overlay.id = "menu-overlay";
      document.body.appendChild(overlay);
    }

    // abre/fecha menu
    toggleMobile?.addEventListener("click", () => {
      sidebarMobile.classList.toggle("open");
      overlay.classList.toggle("show");
    });

    // fecha ao clicar fora
    overlay?.addEventListener("click", () => {
      sidebarMobile.classList.remove("open");
      overlay.classList.remove("show");
    });
  </script>

</body>
</html>
